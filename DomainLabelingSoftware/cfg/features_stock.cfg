SELECT 
AVG(registered_via) AS AVGregistered_viastock,AVG(payment_plan_days) AS AVGpayment_plan_daysstock,AVG(gender) AS AVGgenderstock,AVG(city) AS AVGcitystock,AVG(bd) AS AVGbdstock,AVG(payment_method_id) AS AVGpayment_method_idstock,AVG(is_auto_renew) AS AVGis_auto_renewstock,AVG(plan_list_price) AS AVGplan_list_pricestock,AVG(actual_amount_paid) AS AVGactual_amount_paidstock,AVG(num_unq) AS AVGnum_unqstock,AVG(num_25) AS AVGnum_25stock,AVG(num_100) AS AVGnum_100stock,AVG(total_secs) AS AVGtotal_secsstock,COUNT(registered_via) AS COUNTregistered_viastock,COUNT(payment_plan_days) AS COUNTpayment_plan_daysstock,COUNT(gender) AS COUNTgenderstock,COUNT(city) AS COUNTcitystock,COUNT(bd) AS COUNTbdstock,COUNT(payment_method_id) AS COUNTpayment_method_idstock,COUNT(is_auto_renew) AS COUNTis_auto_renewstock,COUNT(plan_list_price) AS COUNTplan_list_pricestock,COUNT(actual_amount_paid) AS COUNTactual_amount_paidstock,COUNT(num_unq) AS COUNTnum_unqstock,COUNT(num_25) AS COUNTnum_25stock,COUNT(num_100) AS COUNTnum_100stock,COUNT(total_secs) AS COUNTtotal_secsstock,SUM(registered_via) AS SUMregistered_viastock,SUM(payment_plan_days) AS SUMpayment_plan_daysstock,SUM(gender) AS SUMgenderstock,SUM(city) AS SUMcitystock,SUM(bd) AS SUMbdstock,SUM(payment_method_id) AS SUMpayment_method_idstock,SUM(is_auto_renew) AS SUMis_auto_renewstock,SUM(plan_list_price) AS SUMplan_list_pricestock,SUM(actual_amount_paid) AS SUMactual_amount_paidstock,SUM(num_unq) AS SUMnum_unqstock,SUM(num_25) AS SUMnum_25stock,SUM(num_100) AS SUMnum_100stock,SUM(total_secs) AS SUMtotal_secsstock,MAX(registered_via) AS MAXregistered_viastock,MAX(payment_plan_days) AS MAXpayment_plan_daysstock,MAX(gender) AS MAXgenderstock,MAX(city) AS MAXcitystock,MAX(bd) AS MAXbdstock,MAX(payment_method_id) AS MAXpayment_method_idstock,MAX(is_auto_renew) AS MAXis_auto_renewstock,MAX(plan_list_price) AS MAXplan_list_pricestock,MAX(actual_amount_paid) AS MAXactual_amount_paidstock,MAX(num_unq) AS MAXnum_unqstock,MAX(num_25) AS MAXnum_25stock,MAX(num_100) AS MAXnum_100stock,MAX(total_secs) AS MAXtotal_secsstock,a.msno FROM train_raw a 
 left outer join (SELECT DATE(JULIANDAY(MAXdate) - ((JULIANDAY(MAXdate)- JULIANDAY(MINdate)) / 2 )) AS MEDIAN_DATE,
msno, MAXdate, MINdate
 FROM (SELECT MAX(date) AS MAXdate, MIN(date) AS MINdate, msno FROM train_raw GROUP BY msno
)
 group by msno) b 
 on a.msno=b.msno
 WHERE date BETWEEN MEDIAN_DATE AND MAXdate 
 GROUP BY a.msno